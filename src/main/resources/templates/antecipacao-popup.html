<!DOCTYPE html>
<html lang="pt-BR">
<head>
	
	<!-- Meta tags de codificação reforçadas -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<!-- Adicione esta meta tag adicional -->
	<meta http-equiv="Content-Language" content="pt-BR">

	<!-- Outras meta tags -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Processar Antecipação</title>

	<!-- Links para CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
	
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
        }
        
        body {
            padding: 20px;
            background-color: var(--light-gray);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 500px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .action-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .approve-icon {
            color: var(--success-color);
        }
        
        .reject-icon {
            color: var(--danger-color);
        }
        
        #loadingSpinner {
            display: none;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-approve {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-reject {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-close-custom {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            opacity: 0.7;
            cursor: pointer;
        }
        
        .error-message {
            color: var(--danger-color);
            margin-top: 10px;
            display: none;
        }
        
        .is-invalid {
            border-color: var(--danger-color);
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div id="formView">
            <div class="text-center mb-4 position-relative">
                <span class="btn-close-custom" onclick="window.close()">&times;</span>
                <div id="actionIcon" class="action-icon"></div>
                <h3 id="popupTitle" class="text-primary">Processar Antecipação</h3>
                <p id="actionDescription" class="text-muted"></p>
            </div>
            
            <div class="mb-3">
                <label for="observacao" class="form-label">
                    <span id="observacaoLabel">Observação</span>
                    <span class="text-muted" id="observacaoOpcional"> (opcional)</span>
                </label>
                <textarea class="form-control" id="observacao" rows="4" placeholder="Digite sua observação aqui..."></textarea>
                <div id="observacaoHelp" class="form-text text-danger" style="display: none;">
                    Por favor, informe o motivo da reprovação
                </div>
            </div>
            
            <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
                <i class="bi bi-exclamation-triangle-fill"></i> <span id="errorMessage"></span>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <button id="cancelBtn" class="btn btn-outline-secondary w-100 me-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button id="submitBtn" class="btn btn-primary w-100 ms-2">
                    <span id="submitText">
                        <i class="bi bi-send"></i> Enviar
                    </span>
                    <div id="loadingSpinner" class="spinner-border spinner-border-sm ms-2" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Obtém parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const antecipacaoData = {
            id: urlParams.get('id'),
            token: urlParams.get('token'),
            action: urlParams.get('action')
        };
        
        // Configura a interface baseada na ação
        function setupInterface() {
            const actionIcon = document.getElementById('actionIcon');
            const popupTitle = document.getElementById('popupTitle');
            const actionDescription = document.getElementById('actionDescription');
            const observacaoLabel = document.getElementById('observacaoLabel');
            const observacaoOpcional = document.getElementById('observacaoOpcional');
            const submitBtn = document.getElementById('submitBtn');

            if (antecipacaoData.action === 'approve') {
                actionIcon.innerHTML = '<i class="bi bi-check-circle-fill approve-icon"></i>';
                popupTitle.textContent = 'Aprovar Antecipação';
                actionDescription.textContent = 'Você está prestes a aprovar esta antecipação.';
                submitBtn.classList.add('btn-success');
                observacaoLabel.textContent = 'Observação';
                observacaoOpcional.style.display = 'inline';
            } else {
                actionIcon.innerHTML = '<i class="bi bi-x-circle-fill reject-icon"></i>';
                popupTitle.textContent = 'Reprovar Antecipação';
                actionDescription.textContent = 'Você está prestes a reprovar esta antecipação.';
                submitBtn.classList.add('btn-danger');
                observacaoLabel.textContent = 'Motivo';
                observacaoOpcional.style.display = 'none';
            }
        }

        // Função para obter a URL base da API
        function getApiBaseUrl() {
            // Verifica se estamos em desenvolvimento (localhost) ou produção
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:8080/uaitag_cartao_convenio';
            }
            return window.location.origin + '/uaitag_cartao_convenio';
        }

        // Mostra mensagem de erro no popup
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            
            // Rolagem suave para o erro
            errorAlert.scrollIntoView({ behavior: 'smooth' });
        }

        // Esconde mensagem de erro
        function hideError() {
            document.getElementById('errorAlert').style.display = 'none';
        }

        // Processa a antecipação
        async function processarAntecipacao() {
            const observacao     = document.getElementById('observacao').value.trim();
            const loadingSpinner = document.getElementById('loadingSpinner');
            const submitText     = document.getElementById('submitText');
            const submitBtn      = document.getElementById('submitBtn');
            const baseUrl        = getApiBaseUrl();
            
            // Esconde erros anteriores
            hideError();
            
            // Validação para reprovação
            if (antecipacaoData.action === 'reject' && !observacao) {
                document.getElementById('observacaoHelp').style.display = 'block';
                document.getElementById('observacao').classList.add('is-invalid');
                showError('Por favor, informe o motivo da reprovação');
                return;
            }

            // Mostra loading
            submitBtn.disabled = true;
            submitText.innerHTML = '<i class="bi bi-arrow-repeat"></i> Processando';
            loadingSpinner.style.display = 'inline-block';

            try {
			
                let endpoint, method = 'PUT', body;
                const headers = {
                    'Content-Type': 'application/json; charset=UTF-8',
                    'Accept': 'application/json; charset=UTF-8'
                };
	
                if (antecipacaoData.action === 'approve') {
                    endpoint = `/api/antecipacoes/${antecipacaoData.id}/aprovar?token=${encodeURIComponent(antecipacaoData.token)}`;
                    if (observacao) {
                        endpoint += `&motivo=${encodeURIComponent(observacao)}`;
                    }
                } else {
                    endpoint = `/api/antecipacoes/${antecipacaoData.id}/reprovar?token=${encodeURIComponent(antecipacaoData.token)}`;
                    body = JSON.stringify({ motivo: observacao });
                }

                // Verifica conexão antes de fazer a requisição
                if (!navigator.onLine) {
                    throw new Error('Sem conexão com a internet. Verifique sua conexão e tente novamente.');
                }

                // Faz a requisição principal
                const response = await fetch(baseUrl + endpoint, {
                    method: method,
                    headers: headers,
                    body: body || null
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.message || `Erro ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }

                const resultData = await response.json();


				const resultadoUrl =
				  `${baseUrl}/antecipacao/resultado-antecipacao?success=true`
				  + `&action=${encodeURIComponent(antecipacaoData.action)}`
				  + `&message=${encodeURIComponent(resultData.mensagem || (antecipacaoData.action === 'approve'
				      ? 'Antecipação aprovada com sucesso' : 'Antecipação reprovada com sucesso'))}`
				  + `&id=${encodeURIComponent(antecipacaoData.id)}`
				  + (observacao ? `&motivo=${encodeURIComponent(observacao)}` : '');
				  
				window.location.href = resultadoUrl;
 
				                
            } catch (error) {
                console.error('Erro:', error);
                showError(error.message || 'Erro ao processar a solicitação. Tente novamente.');
				alert('Erro:', error);    
				
				
				            
                // Se for erro de conexão, permite tentar novamente
                if (error.message.includes('conexão')) {
                    submitText.innerHTML = '<i class="bi bi-arrow-repeat"></i> Tentar novamente';
                } else {
                    submitText.innerHTML = '<i class="bi bi-send"></i> Enviar';
                }
            } finally {
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            if (!antecipacaoData.id || !antecipacaoData.token || !antecipacaoData.action) {
                const baseUrl = getApiBaseUrl();
                window.location.href = `${baseUrl}/antecipacao/resultado?success=false&message=Parâmetros inválidos`;
                return;
            }

            setupInterface();
            
            document.getElementById('submitBtn').addEventListener('click', processarAntecipacao);
            document.getElementById('cancelBtn').addEventListener('click', () => window.close());
            
            // Validação em tempo real para reprovação
            if (antecipacaoData.action === 'reject') {
                document.getElementById('observacao').addEventListener('input', function() {
                    if (this.value.trim()) {
                        document.getElementById('observacaoHelp').style.display = 'none';
                        this.classList.remove('is-invalid');
                        hideError();
                    }
                });
            }
        });
    </script>
</body>
</html>